---
import DashboardLayout from "../../../layouts/DashboardLayout.astro";
import { prisma } from "../../../lib/db";
import { getSessionFromRequest } from "../../../lib/auth";

const session = await getSessionFromRequest(Astro.request);
const discordId = session?.discordId;
if (!discordId) return Astro.redirect("/api/auth/signin");

const roleId = Astro.url.searchParams.get("id") || "";
if (!roleId) return Astro.redirect("/dashboard/roles");

const user = await prisma.user.upsert({ where: { discordId: String(discordId) }, update: {}, create: { discordId: String(discordId) }});
const network = await prisma.network.findFirst({ where: { ownerId: user.id }, include: { guilds: true } });
if (!network) return Astro.redirect("/dashboard");

const role = await prisma.networkRole.findFirst({ where: { id: roleId, networkId: network.id } });
if (!role) return Astro.redirect("/dashboard/roles");

const mappings = await prisma.roleMapping.findMany({ where: { networkRoleId: role.id }, include: { guild: true }});
const byGuild = new Map(mappings.map(m => [m.guildId, m]));
---
<DashboardLayout
  title={`Mapping: ${role.name}`}
  username={session?.user?.name || user.discordId}
  avatarUrl={session?.avatarUrl}
  backLink={{ href: "/dashboard/roles", label: "Back to Roles" }}
>
  <h1 class="page-title">Role Mapping: {role.name}</h1>
  <p style="color: var(--color-text-muted); margin-bottom: 24px;">
    Map this network role to Discord roles in each server. When a member is granted this role, they will receive the mapped Discord role in each server.
  </p>

  <div class="card">
    <div class="card-title">Server Mappings</div>

    {network.guilds.length > 0 ? (
      <table>
        <thead>
          <tr>
            <th>Server</th>
            <th>Guild ID</th>
            <th>Discord Role ID</th>
            <th>Required</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          {network.guilds.map(g => {
            const m = byGuild.get(g.id);
            return (
              <tr>
                <td style="font-weight: 500;">{g.guildName}</td>
                <td class="mono">{g.guildDiscordId}</td>
                <td>
                  <form method="post" action="/api/network/roles/map" style="display: flex; gap: 8px; align-items: center;">
                    <input type="hidden" name="networkRoleId" value={role.id} />
                    <input type="hidden" name="guildId" value={g.id} />
                    <input
                      type="text"
                      name="roleDiscordId"
                      value={m?.roleDiscordId || ""}
                      placeholder="Discord Role ID"
                      style="width: 200px;"
                    />
                </td>
                <td style="text-align: center;">
                    <input type="checkbox" name="required" checked={m?.required || false} />
                </td>
                <td>
                    <button type="submit" style="padding: 6px 12px; font-size: 13px;">Save</button>
                  </form>
                </td>
              </tr>
            );
          })}
        </tbody>
      </table>
    ) : (
      <div class="empty-state">
        <p>No servers linked yet.</p>
        <p style="font-size: 13px;">Link a server using <strong>/authorize</strong> to configure role mappings.</p>
      </div>
    )}
  </div>

  <div class="card" style="margin-top: 16px;">
    <div class="card-title" style="margin-bottom: 8px;">How to find a Discord Role ID</div>
    <ol style="color: var(--color-text-muted); font-size: 14px; padding-left: 20px; line-height: 1.8;">
      <li>Enable Developer Mode in Discord (User Settings &gt; Advanced &gt; Developer Mode)</li>
      <li>Right-click on the role in Server Settings &gt; Roles</li>
      <li>Click "Copy Role ID"</li>
    </ol>
  </div>
</DashboardLayout>
