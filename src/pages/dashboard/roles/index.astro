---
import DashboardLayout from "../../../layouts/DashboardLayout.astro";
import { prisma } from "../../../lib/db";
import { getSessionFromRequest } from "../../../lib/auth";

const session = await getSessionFromRequest(Astro.request);
const discordId = session?.discordId;
if (!discordId) return Astro.redirect("/api/auth/signin");

const user = await prisma.user.upsert({ where: { discordId: String(discordId) }, update: {}, create: { discordId: String(discordId) }});
const network = await prisma.network.findFirst({ where: { ownerId: user.id } });
if (!network) return Astro.redirect("/dashboard");

const roles = await prisma.networkRole.findMany({ where: { networkId: network.id }, orderBy: { createdAt: "desc" } });
const msg = Astro.url.searchParams.get("msg");
---
<DashboardLayout
  title="Roles"
  username={session?.user?.name || user.discordId}
  avatarUrl={session?.avatarUrl}
>
  <h1 class="page-title">Network Roles</h1>
  <p style="color: var(--color-text-muted); margin-bottom: 24px;">Create roles that can be assigned to members across your network.</p>

  {msg && <div class="message message-success">{msg}</div>}

  <div class="card">
    <div class="card-title">Create New Role</div>
    <form method="post" action="/api/network/roles/create" class="form-row">
      <input type="text" name="name" placeholder="Role name" style="width: 200px;" required />
      <input type="text" name="description" placeholder="Description (optional)" style="width: 300px;" />
      <button type="submit">Create Role</button>
    </form>
  </div>

  <div class="card">
    <div class="card-title">Existing Roles</div>
    {roles.length > 0 ? (
      <ul class="item-list">
        {roles.map(r => (
          <li>
            <div>
              <span class="item-name">{r.name}</span>
              {r.description && <span class="item-desc">{r.description}</span>}
            </div>
            <a href={`/dashboard/roles/mapping?id=${r.id}`} class="btn btn-secondary" style="padding: 6px 12px; font-size: 13px;">
              Configure Mapping
            </a>
          </li>
        ))}
      </ul>
    ) : (
      <div class="empty-state">
        <p>No roles created yet.</p>
        <p style="font-size: 13px;">Create a role above to get started.</p>
      </div>
    )}
  </div>
</DashboardLayout>
