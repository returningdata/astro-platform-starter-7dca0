---
import DashboardLayout from "../../../layouts/DashboardLayout.astro";
import { prisma } from "../../../lib/db";
import { getSessionFromRequest } from "../../../lib/auth";

const session = await getSessionFromRequest(Astro.request);
const discordId = session?.discordId;
if (!discordId) return Astro.redirect("/api/auth/signin");

const user = await prisma.user.upsert({ where: { discordId: String(discordId) }, update: {}, create: { discordId: String(discordId) }});
const network = await prisma.network.findFirst({ where: { ownerId: user.id } });
if (!network) return Astro.redirect("/dashboard");

const roles = await prisma.networkRole.findMany({ where: { networkId: network.id }, orderBy: { name: "asc" } });
const grants = await prisma.roleGrant.findMany({
  where: { revokedAt: null, networkRole: { networkId: network.id } },
  include: { networkRole: true },
  orderBy: { createdAt: "desc" }
});
---
<DashboardLayout
  title="Members"
  username={session?.user?.name || user.discordId}
  avatarUrl={session?.avatarUrl}
>
  <h1 class="page-title">Members</h1>
  <p style="color: var(--color-text-muted); margin-bottom: 24px;">Grant and revoke network roles to members by their Discord ID.</p>

  <div class="card">
    <div class="card-title">Grant Role</div>
    {roles.length > 0 ? (
      <form method="post" action="/api/network/roles/grant" class="form-row">
        <input type="text" name="userDiscordId" placeholder="User Discord ID" style="width: 220px;" required />
        <select name="networkRoleId" style="min-width: 180px;" required>
          <option value="">Select a role...</option>
          {roles.map(r => <option value={r.id}>{r.name}</option>)}
        </select>
        <button type="submit">Grant Role</button>
      </form>
    ) : (
      <p style="color: var(--color-text-muted); font-size: 14px;">
        Create a role first in the <a href="/dashboard/roles" style="color: var(--color-primary);">Roles</a> section.
      </p>
    )}
  </div>

  <div class="card">
    <div class="card-title">Active Grants</div>
    {grants.length > 0 ? (
      <table>
        <thead>
          <tr>
            <th>User Discord ID</th>
            <th>Role</th>
            <th>Granted</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          {grants.map(g => (
            <tr>
              <td class="mono">{g.userDiscordId}</td>
              <td style="font-weight: 500;">{g.networkRole.name}</td>
              <td style="color: var(--color-text-muted);">
                {new Date(g.createdAt).toLocaleDateString('en-US', {
                  year: 'numeric',
                  month: 'short',
                  day: 'numeric',
                  hour: '2-digit',
                  minute: '2-digit'
                })}
              </td>
              <td>
                <form method="post" action="/api/network/roles/revoke">
                  <input type="hidden" name="grantId" value={g.id} />
                  <button type="submit" class="btn-danger" style="padding: 6px 12px; font-size: 13px;">
                    Revoke
                  </button>
                </form>
              </td>
            </tr>
          ))}
        </tbody>
      </table>
    ) : (
      <div class="empty-state">
        <p>No active grants.</p>
        <p style="font-size: 13px;">Grant a role to a user above to see it listed here.</p>
      </div>
    )}
  </div>

  <div class="card" style="margin-top: 16px;">
    <div class="card-title" style="margin-bottom: 8px;">How to find a User Discord ID</div>
    <ol style="color: var(--color-text-muted); font-size: 14px; padding-left: 20px; line-height: 1.8;">
      <li>Enable Developer Mode in Discord (User Settings &gt; Advanced &gt; Developer Mode)</li>
      <li>Right-click on the user's name or avatar</li>
      <li>Click "Copy User ID"</li>
    </ol>
  </div>
</DashboardLayout>
