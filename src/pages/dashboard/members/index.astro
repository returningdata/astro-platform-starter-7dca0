---
import { prisma } from "../../../lib/db";
import { getSessionFromRequest } from "../../../lib/auth";

const session = await getSessionFromRequest(Astro.request);
const discordId = session?.discordId;
if (!discordId) return Astro.redirect("/api/auth/signin");

const user = await prisma.user.upsert({ where: { discordId: String(discordId) }, update: {}, create: { discordId: String(discordId) }});
const network = await prisma.network.findFirst({ where: { ownerId: user.id } });
if (!network) return Astro.redirect("/dashboard");

const roles = await prisma.networkRole.findMany({ where: { networkId: network.id }, orderBy: { name: "asc" } });
const grants = await prisma.roleGrant.findMany({
  where: { revokedAt: null, networkRole: { networkId: network.id } },
  include: { networkRole: true },
  orderBy: { createdAt: "desc" }
});
---
<html lang="en">
<head><meta charset="utf-8" /><meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Members</title></head>
<body style="font-family: system-ui; margin: 40px;">
  <h1>Members / Grants</h1>
  <p><a href="/dashboard">‚Üê Dashboard</a></p>

  <form method="post" action="/api/network/roles/grant" style="display:flex; gap:8px; align-items:center; margin: 16px 0;">
    <input name="userDiscordId" placeholder="User Discord ID" style="padding:8px; width:260px;" />
    <select name="networkRoleId" style="padding:8px;">
      {roles.map(r => <option value={r.id}>{r.name}</option>)}
    </select>
    <button style="padding:8px 12px;">Grant</button>
  </form>

  <h3>Active grants</h3>
  <table border="1" cellpadding="8" style="border-collapse: collapse;">
    <tr><th>User ID</th><th>Role</th><th>Granted</th><th>Revoke</th></tr>
    {grants.map(g => (
      <tr>
        <td style="font-family: ui-monospace;">{g.userDiscordId}</td>
        <td>{g.networkRole.name}</td>
        <td>{new Date(g.createdAt).toLocaleString()}</td>
        <td>
          <form method="post" action="/api/network/roles/revoke">
            <input type="hidden" name="grantId" value={g.id} />
            <button style="padding:6px 10px;">Revoke</button>
          </form>
        </td>
      </tr>
    ))}
  </table>
</body>
</html>
