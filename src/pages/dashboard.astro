---
import DashboardLayout from "../layouts/DashboardLayout.astro";
import { prisma } from "../lib/db";
import { getSessionFromRequest } from "../lib/auth";

const session = await getSessionFromRequest(Astro.request);
const discordId = session?.discordId;

if (!discordId) return Astro.redirect("/api/auth/signin");

const user = await prisma.user.upsert({
  where: { discordId: String(discordId) },
  update: { username: session?.user?.name || null, avatarUrl: session?.avatarUrl || null },
  create: { discordId: String(discordId), username: session?.user?.name || null, avatarUrl: session?.avatarUrl || null }
});

const network = await prisma.network.findFirst({
  where: { ownerId: user.id },
  include: { guilds: true, roles: true }
});
---
<DashboardLayout
  title="Dashboard"
  username={session?.user?.name || user.discordId}
  avatarUrl={session?.avatarUrl}
>
  <h1 class="page-title">Overview</h1>

  {network ? (
    <div class="card">
      <div class="card-title">Network: {network.name}</div>

      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;">
        <div style="background: var(--color-bg); padding: 16px; border-radius: var(--radius);">
          <div style="font-size: 28px; font-weight: 600;">{network.guilds.length}</div>
          <div style="color: var(--color-text-muted); font-size: 14px;">Linked Servers</div>
        </div>
        <div style="background: var(--color-bg); padding: 16px; border-radius: var(--radius);">
          <div style="font-size: 28px; font-weight: 600;">{network.roles.length}</div>
          <div style="color: var(--color-text-muted); font-size: 14px;">Network Roles</div>
        </div>
      </div>

      {network.guilds.length > 0 ? (
        <>
          <div class="card-title" style="margin-top: 24px;">Linked Servers</div>
          <ul class="item-list">
            {network.guilds.map(g => (
              <li>
                <span class="item-name">{g.guildName}</span>
                <span class="mono">{g.guildDiscordId}</span>
              </li>
            ))}
          </ul>
        </>
      ) : (
        <div class="empty-state">
          <p>No servers linked yet.</p>
          <p style="font-size: 13px;">Run <strong>/authorize</strong> in a Discord server to link it to your network.</p>
        </div>
      )}
    </div>
  ) : (
    <div class="card">
      <div class="empty-state">
        <p>No network created yet.</p>
        <p style="font-size: 13px;">Run <strong>/authorize</strong> in a Discord server to create your network and link your first server.</p>
      </div>
    </div>
  )}

  <div class="card" style="margin-top: 24px;">
    <div class="card-title">Quick Actions</div>
    <div style="display: flex; gap: 12px; flex-wrap: wrap;">
      <a href="/dashboard/roles" class="btn">Manage Roles</a>
      <a href="/dashboard/members" class="btn btn-secondary">Manage Members</a>
      <a href="/dashboard/sync" class="btn btn-secondary">View Sync Status</a>
    </div>
  </div>
</DashboardLayout>
